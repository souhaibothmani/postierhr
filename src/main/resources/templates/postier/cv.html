<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head}"></head>
<body>
    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <div class="container mt-4">
        <!-- En-tête -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>
                        <i class="bi bi-file-text-fill me-2"></i>
                        Mon CV
                    </h1>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="imprimerCV()" th:if="${hasCv}">
                            <i class="bi bi-printer-fill me-1"></i>
                            Imprimer
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="supprimerCV()" th:if="${hasCv}">
                            <i class="bi bi-trash-fill me-1"></i>
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message d'information si pas de CV -->
        <div class="row" th:unless="${hasCv}">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>Aucun CV trouvé.</strong>
                    Créez votre CV professionnel pour postuler aux concours internes.
                </div>
            </div>
        </div>

        <!-- Formulaire de CV -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            <span th:text="${hasCv} ? 'Modifier mon CV' : 'Créer mon CV'">Créer mon CV</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="cvForm">
                            <div class="row">
                                <!-- Résumé professionnel -->
                                <div class="col-12 mb-4">
                                    <label for="resume" class="form-label fw-bold">
                                        <i class="bi bi-person-lines-fill me-1"></i>
                                        Résumé professionnel
                                    </label>
                                    <textarea class="form-control" 
                                              id="resume" 
                                              name="resume" 
                                              rows="4" 
                                              maxlength="2000"
                                              placeholder="Décrivez brièvement votre profil professionnel, vos objectifs et vos principales qualités..."
                                              th:text="${cv?.resume}"></textarea>
                                    <div class="form-text">Maximum 2000 caractères</div>
                                </div>

                                <!-- Compétences -->
                                <div class="col-12 mb-4">
                                    <label for="competences" class="form-label fw-bold">
                                        <i class="bi bi-gear-fill me-1"></i>
                                        Compétences
                                    </label>
                                    <textarea class="form-control" 
                                              id="competences" 
                                              name="competences" 
                                              rows="4" 
                                              maxlength="2000"
                                              placeholder="Listez vos compétences techniques et professionnelles..."
                                              th:text="${cv?.competences}"></textarea>
                                    <div class="form-text">Maximum 2000 caractères</div>
                                </div>

                                <!-- Formation -->
                                <div class="col-md-6 mb-4">
                                    <label for="formation" class="form-label fw-bold">
                                        <i class="bi bi-mortarboard-fill me-1"></i>
                                        Formation
                                    </label>
                                    <textarea class="form-control" 
                                              id="formation" 
                                              name="formation" 
                                              rows="6" 
                                              maxlength="2000"
                                              placeholder="Indiquez vos diplômes, formations et certifications...
Exemple:
2020 - CAP Distribution d'objets et services à la clientèle
2018 - Baccalauréat professionnel Gestion-Administration"
                                              th:text="${cv?.formation}"></textarea>
                                    <div class="form-text">Maximum 2000 caractères</div>
                                </div>

                                <!-- Expériences -->
                                <div class="col-md-6 mb-4">
                                    <label for="experiences" class="form-label fw-bold">
                                        <i class="bi bi-briefcase-fill me-1"></i>
                                        Expériences professionnelles
                                    </label>
                                    <textarea class="form-control" 
                                              id="experiences" 
                                              name="experiences" 
                                              rows="6" 
                                              maxlength="5000"
                                              placeholder="Décrivez vos expériences professionnelles...
Exemple:
2020-2024 - Facteur à La Poste, Bureau de Poste Centre
- Distribution du courrier et des colis
- Accueil et conseil clientèle
- Gestion des réclamations"
                                              th:text="${cv?.experiences}"></textarea>
                                    <div class="form-text">Maximum 5000 caractères</div>
                                </div>

                                <!-- Langues -->
                                <div class="col-12 mb-4">
                                    <label for="langues" class="form-label fw-bold">
                                        <i class="bi bi-translate me-1"></i>
                                        Langues
                                    </label>
                                    <textarea class="form-control" 
                                              id="langues" 
                                              name="langues" 
                                              rows="3" 
                                              maxlength="1000"
                                              placeholder="Indiquez les langues que vous maîtrisez avec votre niveau...
Exemple:
- Français : Langue maternelle
- Anglais : Niveau B2 (intermédiaire)
- Espagnol : Niveau A2 (débutant)"
                                              th:text="${cv?.langues}"></textarea>
                                    <div class="form-text">Maximum 1000 caractères</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <div>
                                    <small class="text-muted" th:if="${cv?.derniereModification}">
                                        <i class="bi bi-clock me-1"></i>
                                        Dernière modification : <span th:text="${#temporals.format(cv.derniereModification, 'dd/MM/yyyy HH:mm')}"></span>
                                    </small>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save-fill me-2"></i>
                                        <span th:text="${hasCv} ? 'Mettre à jour' : 'Créer mon CV'">Sauvegarder</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Soumission du formulaire CV
        document.getElementById('cvForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            fetch('/api/cv/me', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('CV sauvegardé avec succès !');
                    location.reload();
                } else if (data.error) {
                    alert('Erreur : ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur s\'est produite lors de la sauvegarde.');
            });
        });

        // Impression du CV
        function imprimerCV() {
            fetch('/api/cv/print', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                } else if (data.error) {
                    alert('Erreur : ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur s\'est produite lors de l\'impression.');
            });
        }

        // Suppression du CV
        function supprimerCV() {
            if (confirm('Êtes-vous sûr de vouloir supprimer votre CV ? Cette action est irréversible.')) {
                fetch('/api/cv/me', {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert('CV supprimé avec succès !');
                        location.reload();
                    } else if (data.error) {
                        alert('Erreur : ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur s\'est produite lors de la suppression.');
                });
            }
        }

        // Compteur de caractères
        document.querySelectorAll('textarea[maxlength]').forEach(textarea => {
            const maxLength = textarea.getAttribute('maxlength');
            const formText = textarea.nextElementSibling;
            
            textarea.addEventListener('input', function() {
                const remaining = maxLength - this.value.length;
                formText.textContent = `${this.value.length}/${maxLength} caractères`;
                
                if (remaining < 100) {
                    formText.classList.add('text-warning');
                } else {
                    formText.classList.remove('text-warning');
                }
                
                if (remaining < 0) {
                    formText.classList.add('text-danger');
                    formText.classList.remove('text-warning');
                } else {
                    formText.classList.remove('text-danger');
                }
            });
            
            // Trigger initial count
            textarea.dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>